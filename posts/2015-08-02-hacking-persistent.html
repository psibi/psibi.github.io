<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Sibi - Hacking Persistent</title>
	 <meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="https://fonts.googleapis.com/css?family=Lato:400,400i,700,700i|Source+Serif+Pro:400,700|Space+Mono" rel="stylesheet">
	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" type="text/css">
	<link rel="stylesheet" type="text/css" href="../css/default.css" />
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    </head>
    <body>
	 <!-- Fixed navbar -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../">Sibi</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li class="active"><a href="../">Home</a></li>
            <li><a href="../about.html">About</a></li>
            <li><a href="../contact.html">Contact</a></li>
	    <li><a href="../archive.html">Archive</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
        <div id="content" class="container">
            <div class="article">
<div class="post-index">
    <h1>Hacking Persistent</h1>
    <span class="date">August  2, 2015</span>
</div>

<p>I’m a big fan of <a href="https://github.com/yesodweb/persistent/">persistent</a> as it offers compile time integrity checks for your database. Whenever I need to model a new schema, I usually use this tool to come up with the design. As I model and typecheck the code, I usually use the <code>printMigration</code> function to see the translated SQL queries. The code looks something like this:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" title="1"><span class="ot">{-# LANGUAGE EmptyDataDecls             #-}</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="ot">{-# LANGUAGE FlexibleContexts           #-}</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="ot">{-# LANGUAGE GADTs                      #-}</span></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="ot">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="ot">{-# LANGUAGE MultiParamTypeClasses      #-}</span></a>
<a class="sourceLine" id="cb1-6" title="6"><span class="ot">{-# LANGUAGE OverloadedStrings          #-}</span></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="ot">{-# LANGUAGE QuasiQuotes                #-}</span></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="ot">{-# LANGUAGE TemplateHaskell            #-}</span></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="ot">{-# LANGUAGE TypeFamilies               #-}</span></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="kw">import</span> <span class="dt">Control.Monad.IO.Class</span>  (liftIO)</a>
<a class="sourceLine" id="cb1-11" title="11"><span class="kw">import</span> <span class="dt">Control.Monad.Logger</span>    (runStderrLoggingT)</a>
<a class="sourceLine" id="cb1-12" title="12"><span class="kw">import</span> <span class="dt">Database.Persist</span></a>
<a class="sourceLine" id="cb1-13" title="13"><span class="kw">import</span> <span class="dt">Database.Persist.Postgresql</span></a>
<a class="sourceLine" id="cb1-14" title="14"><span class="kw">import</span> <span class="dt">Database.Persist.TH</span></a>
<a class="sourceLine" id="cb1-15" title="15"></a>
<a class="sourceLine" id="cb1-16" title="16">share [mkPersist sqlSettings, mkMigrate <span class="st">&quot;migrateAll&quot;</span>]</a>
<a class="sourceLine" id="cb1-17" title="17">          [persistLowerCase|</a>
<a class="sourceLine" id="cb1-18" title="18">Person</a>
<a class="sourceLine" id="cb1-19" title="19">    name String</a>
<a class="sourceLine" id="cb1-20" title="20">    age Int Maybe</a>
<a class="sourceLine" id="cb1-21" title="21">    address Int</a>
<a class="sourceLine" id="cb1-22" title="22">    deriving Show</a>
<a class="sourceLine" id="cb1-23" title="23">BlogPost</a>
<a class="sourceLine" id="cb1-24" title="24">    title String</a>
<a class="sourceLine" id="cb1-25" title="25">    authorId PersonId</a>
<a class="sourceLine" id="cb1-26" title="26">    deriving Show</a>
<a class="sourceLine" id="cb1-27" title="27">|]</a>
<a class="sourceLine" id="cb1-28" title="28"></a>
<a class="sourceLine" id="cb1-29" title="29">connStr <span class="ot">=</span> <span class="st">&quot;host=localhost dbname=test user=test password=test port=5432&quot;</span></a>
<a class="sourceLine" id="cb1-30" title="30"></a>
<a class="sourceLine" id="cb1-31" title="31"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb1-32" title="32">main <span class="ot">=</span> runStderrLoggingT <span class="op">$</span> withPostgresqlPool connStr <span class="dv">10</span> <span class="op">$</span></a>
<a class="sourceLine" id="cb1-33" title="33">       \pool <span class="ot">-&gt;</span> liftIO <span class="op">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-34" title="34">                  <span class="fu">flip</span> runSqlPersistMPool pool <span class="op">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-35" title="35">                           printMigration migrateAll</a></code></pre></div>
<p>But there is a slight problem with this code. For the program to run successfully, It needs an actual database to be present in the system. With that being in mind, I filed an <a href="https://github.com/yesodweb/persistent/issues/274">issue</a> hoping it would be fixed. After around 10 months and with a little push from <a href="https://github.com/yesodweb/persistent/issues/274#issuecomment-122727546">Michael Snoyman</a>, I finally started working on the patch. As I studied the code, I sent a <a href="https://github.com/yesodweb/persistent/pull/430">series</a> <a href="https://github.com/yesodweb/persistent/pull/426">of</a> <a href="https://github.com/yesodweb/persistent/pull/425">cleanup</a> <a href="https://github.com/yesodweb/persistent/pull/424">patches</a>. Finally I figured out the problem with the actual issue and wrote a patch for <a href="https://github.com/yesodweb/persistent/pull/436">PostgreSQL driver</a> for it. Right now it is merged and lives in the master. So for the above code to run properly without the actual database being present, make use of the <code>mockMigration</code> function:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" title="1"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb2-2" title="2">main <span class="ot">=</span> mockMigration migrateAll</a></code></pre></div>
<p>And that will print the migration for your designed database. And today I have sent a pull request for the <a href="https://github.com/yesodweb/persistent/pull/439">MySQL backend</a>. Once it gets merged, you can also use this functionality for designing schemas using MySQL too. And yes, this is the first time I’m doing the development of Haskell packages using <a href="https://nixos.org/nix/">Nix</a>.</p>

<div id="disqus_thread">
</div>
<script>
    var disqus_config = function () {
    this.page.url = "http://psibi.in/posts/2015-08-02-hacking-persistent.html";
    this.page.identifier = "posts/2015-08-02-hacking-persistent.md";
    };

    (function() {  // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    
    s.src = '//psibi.disqus.com/embed.js';
    
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<div id="disqus_thread"></div>
</div>

        </div>
        <div id="footer">
            Site generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>
	<script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-27311575-2', 'auto');
	    ga('send', 'pageview');
	    
	    // Hack for adding active class to the li tag.
	    var litags = document.getElementById("navbar").getElementsByTagName("li");
	    litags[0].className = "";
	    litags[1].className = "";
	    litags[2].className = "";
	    litags[3].className = "";
	    var currentPage = window.location.href.split('/')[3];
	    if (currentPage === "")
	       litags[0].className = "active";
	    if (currentPage === "about.html")
	       litags[1].className = "active";
	    if (currentPage === "contact.html")
	       litags[2].className = "active";
	    if (currentPage === "archive.html")
	       litags[3].className = "active";
	</script>
    </body>
</html>
