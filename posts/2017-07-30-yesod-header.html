<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Sibi - Replacing headers in Yesod</title>
	 <meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="https://fonts.googleapis.com/css?family=Lato:400,400i,700,700i|Source+Serif+Pro:400,700|Space+Mono" rel="stylesheet">
	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" type="text/css">
	<link rel="stylesheet" type="text/css" href="../css/default.css" />
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    </head>
    <body>
	 <!-- Fixed navbar -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../">Sibi</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li class="active"><a href="../">Home</a></li>
            <li><a href="../about.html">About</a></li>
            <li><a href="../contact.html">Contact</a></li>
	    <li><a href="../archive.html">Archive</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
        <div id="content" class="container">
            <div class="article">
<div class="post-index">
    <h1>Replacing headers in Yesod</h1>
    <span class="date">July 30, 2017</span>
</div>

<p>Recently a issue was <a href="https://github.com/yesodweb/yesod/issues/1415">raised in the bug tracker</a> regarding the way to overwrite a HTTP response header in Yesod. Maximilian Tagher <a href="https://github.com/yesodweb/yesod/issues/1415#issuecomment-313882369">brought a valid point</a> that multiple header values are indeed acceptable according to the HTTP RFC specification. Further down the conversation, it was suggested to use WAI middleware for controlling the response. But again, this was a workaround and not a clean solution IMO.</p>
<h2 id="is-this-a-sane-thing-to-do">Is this a sane thing to do ?</h2>
<p>My first question was whether replacing header value was a sane thing to do in the framework level ? I went on to see if other framework are providing this. Both <a href="https://docs.djangoproject.com/en/1.11/ref/request-response/#setting-header-fields">Django framework</a> and <a href="https://stackoverflow.com/a/17219300/1651941">Express.js</a> allowed modifying them. Given that the ecosystem in Python and Node.js allowed that, it meant that we are missing that in our Yesod.</p>
<h2 id="yeah-go-for-it">Yeah, go for it!</h2>
<p>So armed with the knowledge that it wouldn’t be a wrong thing to do, I decided to add the relevant functionaity to Yesod. My initial patch didn’t take into the account that the header names are case insensitive according to the specification. After some iteration and refinement, this was the final working code:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" title="1"><span class="ot">replaceOrAddHeader ::</span> <span class="dt">MonadHandler</span> m <span class="ot">=&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> m ()</a>
<a class="sourceLine" id="cb1-2" title="2">replaceOrAddHeader a b <span class="ot">=</span></a>
<a class="sourceLine" id="cb1-3" title="3">  modify <span class="op">$</span> \g <span class="ot">-&gt;</span> g {ghsHeaders <span class="ot">=</span> replaceHeader (ghsHeaders g)}</a>
<a class="sourceLine" id="cb1-4" title="4">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-5" title="5">    repHeader <span class="ot">=</span> <span class="dt">Header</span> (encodeUtf8 a) (encodeUtf8 b)</a>
<a class="sourceLine" id="cb1-6" title="6"></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="ot">    sameHeaderName ::</span> <span class="dt">Header</span> <span class="ot">-&gt;</span> <span class="dt">Header</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb1-8" title="8">    sameHeaderName (<span class="dt">Header</span> n1 _) (<span class="dt">Header</span> n2 _) <span class="ot">=</span> T.toLower (decodeUtf8 n1) <span class="op">==</span> T.toLower (decodeUtf8 n2)</a>
<a class="sourceLine" id="cb1-9" title="9">    sameHeaderName _ _ <span class="ot">=</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb1-10" title="10"></a>
<a class="sourceLine" id="cb1-11" title="11"><span class="ot">    replaceIndividualHeader ::</span> [<span class="dt">Header</span>] <span class="ot">-&gt;</span> [<span class="dt">Header</span>]</a>
<a class="sourceLine" id="cb1-12" title="12">    replaceIndividualHeader [] <span class="ot">=</span> [repHeader]</a>
<a class="sourceLine" id="cb1-13" title="13">    replaceIndividualHeader xs <span class="ot">=</span> aux xs []</a>
<a class="sourceLine" id="cb1-14" title="14">      <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-15" title="15">        aux [] acc <span class="ot">=</span> acc <span class="op">++</span> [repHeader]</a>
<a class="sourceLine" id="cb1-16" title="16">        aux (x<span class="op">:</span>xs') acc <span class="ot">=</span></a>
<a class="sourceLine" id="cb1-17" title="17">          <span class="kw">if</span> sameHeaderName repHeader x</a>
<a class="sourceLine" id="cb1-18" title="18">            <span class="kw">then</span> acc <span class="op">++</span></a>
<a class="sourceLine" id="cb1-19" title="19">                 [repHeader] <span class="op">++</span></a>
<a class="sourceLine" id="cb1-20" title="20">                 (<span class="fu">filter</span> (\header <span class="ot">-&gt;</span> <span class="fu">not</span> (sameHeaderName header repHeader)) xs')</a>
<a class="sourceLine" id="cb1-21" title="21">            <span class="kw">else</span> aux xs' (acc <span class="op">++</span> [x])</a>
<a class="sourceLine" id="cb1-22" title="22"></a>
<a class="sourceLine" id="cb1-23" title="23"><span class="ot">    replaceHeader ::</span> <span class="dt">Endo</span> [<span class="dt">Header</span>] <span class="ot">-&gt;</span> <span class="dt">Endo</span> [<span class="dt">Header</span>]</a>
<a class="sourceLine" id="cb1-24" title="24">    replaceHeader endo <span class="ot">=</span></a>
<a class="sourceLine" id="cb1-25" title="25">      <span class="kw">let</span><span class="ot"> allHeaders ::</span> [<span class="dt">Header</span>] <span class="ot">=</span> appEndo endo []</a>
<a class="sourceLine" id="cb1-26" title="26">      <span class="kw">in</span> <span class="dt">Endo</span> (\rest <span class="ot">-&gt;</span> replaceIndividualHeader allHeaders <span class="op">++</span> rest)</a></code></pre></div>
<p>I merged the <a href="https://github.com/yesodweb/yesod/pull/1417">PR</a> two days ago. This function will be available under the module <code>Yesod.Core.Handler</code> from <code>yesod-core-1.4.36</code>. Thanks to Paul Rose and Michael Snoyman for the detailed review. One design issue I observed while creating the patch was the the <code>Header</code> filed was represented by a <code>ByteString</code>. I have opened a <a href="https://github.com/yesodweb/yesod/issues/1418">new issue</a> to move it to a <code>CI</code> type constructor for case insensitive equality checking. I will try to make that change in the next major release of Yesod as it breaks backward compatibility. That will help in cleaning up the above code slightly.</p>

<div id="disqus_thread">
</div>
<script>
    var disqus_config = function () {
    this.page.url = "http://psibi.in/posts/2017-07-30-yesod-header.html";
    this.page.identifier = "posts/2017-07-30-yesod-header.md";
    };

    (function() {  // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    
    s.src = '//psibi.disqus.com/embed.js';
    
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<div id="disqus_thread"></div>
</div>

        </div>
        <div id="footer">
            Site generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>
	<script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-27311575-2', 'auto');
	    ga('send', 'pageview');
	    
	    // Hack for adding active class to the li tag.
	    var litags = document.getElementById("navbar").getElementsByTagName("li");
	    litags[0].className = "";
	    litags[1].className = "";
	    litags[2].className = "";
	    litags[3].className = "";
	    var currentPage = window.location.href.split('/')[3];
	    if (currentPage === "")
	       litags[0].className = "active";
	    if (currentPage === "about.html")
	       litags[1].className = "active";
	    if (currentPage === "contact.html")
	       litags[2].className = "active";
	    if (currentPage === "archive.html")
	       litags[3].className = "active";
	</script>
    </body>
</html>
