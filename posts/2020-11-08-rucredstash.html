<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Sibi - Rucredstash release & Rust experience from an Haskeller</title>
	 <meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="https://fonts.googleapis.com/css?family=Lato:400,400i,700,700i|Source+Serif+Pro:400,700|Space+Mono" rel="stylesheet">
	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" type="text/css">
	<link rel="stylesheet" type="text/css" href="../css/default.css" />
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    </head>
    <body>
	 <!-- Fixed navbar -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../">Sibi</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li class="active"><a href="../">Home</a></li>
            <li><a href="../about.html">About</a></li>
            <li><a href="../contact.html">Contact</a></li>
	    <li><a href="../archive.html">Archive</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
        <div id="content" class="container">
            <div class="article">
<div class="post-index">
    <h1>Rucredstash release & Rust experience from an Haskeller</h1>
    <span class="date">November  8, 2020</span>
</div>

<h2 id="credstash">Credstash</h2>
<p>Credstash is a cli utility for managing credentials securely in AWS cloud. It uses a combination of AWS Key Management Service (KMS) and DynamoDB to achieve it. One of my co-workers have written a more <a href="https://www.fpcomplete.com/blog/2017/08/credstash">detailed tutorial</a> here. The original tool was written by a company named <a href="https://github.com/fugue/credstash">Fugue</a> in Python. It has been implemented in various languages including the Rust one which I have authored.</p>
<h2 id="new-release-v0.8.0">New release v0.8.0</h2>
<p>I recently released a new version of credstash (todo: git link) and with that, <em>rucredstash</em> cli executable becomes a drop in replacement to the original credstash program. While you could use it previously too, it lacked the <em>putall</em> subcommand. The reason I didn’t implement it previously was because I wasn’t fond of that subcommand. It has three different ways of operating:</p>
<h3 id="passing-data-via-file">Passing data via file</h3>
<p>You can pass the input from a file using the special symbol <code>@</code> to indicate that the data is fed from the file:</p>
<pre class="shellsession"><code>$ bat secrets.json
───────┬────────────────────────────────────────
       │ File: secrets.json
───────┼────────────────────────────────────────
   1   │ {
   2   │     &quot;hello&quot;: &quot;world&quot;,
   3   │     &quot;hi&quot;: &quot;bye&quot;
   4   │ }
───────┴────────────────────────────────────────
$ rucredstash putall @secrets.json
hello has been stored
hi has been stored</code></pre>
<h3 id="passing-data-via-stdin">Passing data via stdin</h3>
<p>You can also pass the data via stdin using the special operator <code>-</code>:</p>
<pre class="shellsession"><code>$ rucredstash putall -
{ &quot;hello&quot;: &quot;world&quot; }
hello has been stored</code></pre>
<p>You press the <a href="https://en.wikipedia.org/wiki/Enter_key%20%22Enter%20key%22">Enter key</a> to indicate that you have finished passing the data.</p>
<h3 id="passing-data-directly">Passing data directly</h3>
<pre class="shellsession"><code>$ rucredstash putall '{&quot;hello&quot;:&quot;world&quot;,&quot;hi&quot;:&quot;bye&quot;}'
hello has been stored
hi has been stored</code></pre>
<p>I disliked the above overloaded behavior and wanted to give a better user experience in my Rust implementation. But that meant breaking compatibility with the original program. So, I finally bit the bullet and implemented it. With that, it becomes a drop in replacement for the original Python program which was my primary goal.</p>
<h2 id="comparing-rust-with-haskell">Comparing Rust with Haskell</h2>
<p>I started learning Rust a couple of years ago and initially wasn’t really enthusiastic about learning a new language which didn’t have a garbage collector. My primary language at work and hobby is Haskell and I didn’t really see what value Rust would add. But I’m happy that I made the investment to learn it and this section will try to compare Rust with Haskell in terms of library quality, community, documentation etc. Note that my experience is based on writing and maintaining <em>rucredstash</em> which is more than a year now. Also, my codebase isn’t that big so probably my view would change based on more experience:</p>
<pre class="shellsession"><code>$ cloc src tests/
       5 text files.
       5 unique files.
       0 files ignored.

github.com/AlDanial/cloc v 1.74  T=0.01 s (382.4 files/s, 170528.1 lines/s)
-------------------------------------------------------------------------------
Language                     files          blank        comment           code
-------------------------------------------------------------------------------
Rust                             4            149            123           1918
Bourne Shell                     1             13              0             27
-------------------------------------------------------------------------------
SUM:                             5            162            123           1945
-------------------------------------------------------------------------------</code></pre>
<p>So it’s roughly around 2000 source code of line. My initial code was based on futures as the <a href="https://crates.io/crates/rusoto">rusoto crate</a> which I use to interact with the AWS API didn’t support async/await yet. And that was pretty ugly. But once the crate supported async/await, the migration was smooth and the new code was much simpler.</p>
<p>I find the Rust community to be quite active and responsive. It was easy for me to <a href="https://github.com/rusoto/rusoto/pull/1649/files">contribute</a> to it. Also one of the stark difference between Rust and the Haskell community is the way they approach the problem. In Haskell, it’s discouraged to use the <a href="https://www.reddit.com/r/haskell/comments/5gospp/dont_use_typeclasses_to_define_default_values/">Default typeclass</a> to define default values. As compared to this, Rust provides a <a href="https://doc.rust-lang.org/std/default/trait.Default.html">Default trait</a> in the standard library itself. Infact, Rust’s <a href="https://github.com/rust-lang/rust-clippy">lint checker</a> suggested me to use that in one of the places!</p>
<p>Now I’m going to compare Rust and Haskell’s library for the same task. Let me pick two libraries which I hope will demonstrate the point I’m tring to convey:</p>
<table>
<thead>
<tr class="header">
<th>Task</th>
<th>Haskell library</th>
<th>Rust Library</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>CLI</td>
<td><a href="https://github.com/pcapriotti/optparse-applicative">optparse-applicative</a></td>
<td><a href="https://github.com/clap-rs/clap">clap</a></td>
</tr>
<tr class="even">
<td>AWS API</td>
<td><a href="https://github.com/brendanhay/amazonka">amazonka</a></td>
<td><a href="https://github.com/rusoto/rusoto/pull/1649/files">rusoto</a></td>
</tr>
</tbody>
</table>
<p>Compared to Haskell’s optparse-applicative, my experience with clap was that I had to write a lots of boilerplate code to parse the value from <a href="https://docs.rs/clap/2.33.3/clap/struct.ArgMatches.html">ArgMatches</a>. One of my co-worker mentioned to me that I should use <a href="https://github.com/TeXitoi/structopt">structopt</a> for that. Also, there are various method in the clap crate like <a href="https://docs.rs/clap/2.33.3/clap/struct.Arg.html#method.conflicts_with">conflicts_with</a>, <a href="https://docs.rs/clap/2.33.3/clap/struct.Arg.html#method.requires">requires</a> and the related method which is quite nice. In my experience, expressing that kind of relationship using optparse-applicative is quite hard and the reason I guess is technical (optparse-applicative relying on Applicative).</p>
<p>I think comparing amazonka with rusoto is unfair. Mostly because amazonka is <a href="https://github.com/brendanhay/amazonka/issues/574">unmaintained</a>. But the reason for comparing them is to point out that Rust community usually seems to be much active and it’s libraries are much well maintained. Also, building amazonka package takes huge amount of memory. In fact, <a href="https://github.com/brendanhay/amazonka/issues/549">amazonka-ec2</a> needs around 7GB of memory. I dread every time CI tries to build an amazonka package without the cache. Let me use the optparse-applicative example to drive the same message. An <a href="https://github.com/pcapriotti/optparse-applicative/issues/118">issue was opened on 2014</a> in the optparse-applicative repository regarding supporting options via environment variables. A similar <a href="https://github.com/clap-rs/clap/issues/814">issue was opened on 2017</a> in clap and a <a href="https://github.com/clap-rs/clap/pull/1062">PR for that</a> was merged on the same year. But compared to this, there is no such feature yet implemented for optparse-applicative.</p>
<p>Also, the documentation of Rust libraries in general is top notch. Although there has been recent efforts in the Haskell community to improve the base docs, the Rust standard library is way ahead. Also the <a href="https://doc.rust-lang.org/book/">Rust book</a> is really nice and makes it easy to learn the language itself.</p>
<p>That being said, I should note that Rust and Haskell are different languages with different trade offs. It would be even unfair to compare them on language basis. (Although I feel this <a href="https://www.fpcomplete.com/blog/2018/11/haskell-and-rust/">blog post</a> does a nice job of comparing them!). One part of the language which I I’m starting to prefer is Rust’s error handling. It’s much easier to comprehend than Haskell’s exception mechanism. Doing safe <a href="https://www.fpcomplete.com/haskell/tutorial/exceptions/">exception handling</a> in Haskell isn’t easy and with the presence of async exceptions things get more complicated. You don’t have to deal with such issues in Rust as errors are modelled via enum type and you can use the <code>?</code> operator to easily propagate it. Also this will likely make the FFI integration story much easier.</p>
<p>And that kind of summarizes my experience with Rust as a Haskell programmer. I’m planning to reach out more t Rust in future for the things which I would have previously used Haskell.</p>
<h2 id="future-improvements">Future improvements</h2>
<p>With v0.8.0 of rucredstash released, I still think there are lots of improvements which can be done. Some of them are:</p>
<ul>
<li>Integrate <a href="https://github.com/rust-lang/rust-clippy">clippy</a> in the
<ol start="101" type="I">
<li></li>
</ol></li>
<li>While the <a href="https://github.com/psibi/rucredstash/blob/c315f1428dfd02b143eb9404fe08b9f37d41ccf7/src/lib.rs#L1">library module</a> is completely panic free, I think the <a href="https://github.com/psibi/rucredstash/blob/master/src/main.rs">CLI driver</a> still has scope of improvements. There are several places where I’m using <a href="https://doc.rust-lang.org/std/option/enum.Option.html#method.expect">expect</a> method which needs to be fixed. It shouldn’t be hard IMO. :-)</li>
<li>Add a new subcommand for <code>setup</code>. Something along the line of <code>setup cmk</code> probably which should setup the <a href="https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#master_keys">Customer master key</a>. Note that this functionality isn’t present in the original credstash program.</li>
<li>Experiment with structopt crate and see how it goes!</li>
</ul>

<div id="disqus_thread">
</div>
<script>
    var disqus_config = function () {
    this.page.url = "https://psibi.in/posts/2020-11-08-rucredstash.html";
    this.page.identifier = "posts/2020-11-08-rucredstash.md";
    };

    (function() {  // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    
    s.src = '//psibi.disqus.com/embed.js';
    
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<div id="disqus_thread"></div>
</div>

        </div>
        <div id="footer">
            Site generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>
	<script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-27311575-2', 'auto');
	    ga('send', 'pageview');
	    
	    // Hack for adding active class to the li tag.
	    var litags = document.getElementById("navbar").getElementsByTagName("li");
	    litags[0].className = "";
	    litags[1].className = "";
	    litags[2].className = "";
	    litags[3].className = "";
	    var currentPage = window.location.href.split('/')[3];
	    if (currentPage === "")
	       litags[0].className = "active";
	    if (currentPage === "about.html")
	       litags[1].className = "active";
	    if (currentPage === "contact.html")
	       litags[2].className = "active";
	    if (currentPage === "archive.html")
	       litags[3].className = "active";
	</script>
    </body>
</html>
